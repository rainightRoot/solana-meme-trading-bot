# 测试指南

## 概述

本目录包含了完整的测试工具套件，用于验证 Solana 交易机器人的各项功能。测试套件包含四个核心组件：

1. **数据生成器** (`testDataGenerator.ts`) - 创建测试数据和模拟持仓
2. **策略测试器** (`sellStrategyTester.ts`) - 测试卖出策略逻辑
3. **系统监控器** (`systemMonitor.ts`) - 监控系统健康状态
4. **端到端测试** (`e2eTestSuite.ts`) - 完整的集成测试

## 快速开始

### 1. 运行快速测试（推荐）

```bash
npm run test
# 或者
npm run test:quick
```

这个命令会运行最核心的测试组件，包括系统检查、数据生成和策略测试。

### 2. 运行完整测试

```bash
npm run test:full
```

运行所有测试组件，包括压力测试和详细的系统验证。

## 单独测试工具

### 系统健康检查

```bash
npm run test:health
```

快速检查系统各个组件的健康状态：
- 数据库连接
- 配置有效性
- 区块链连接
- 钱包状态
- 监控服务
- 持仓健康度
- 卖出策略配置

### 生成测试数据

```bash
npm run test:data
```

创建各种测试场景的持仓数据：
- 盈利持仓（触发获利卖出）
- 亏损持仓（触发止损卖出）
- 回撤持仓（触发回撤保护）
- 二次卖出持仓
- 三次卖出持仓
- 边界情况测试

### 测试卖出策略

```bash
npm run test:strategy
```

测试各种卖出策略的触发逻辑：
- 价格波动模拟
- 策略条件验证
- 交易执行测试
- 压力测试

### 系统监控

```bash
npm run test:monitor
```

启动实时系统监控，每30秒更新一次状态。

## 测试场景详解

### 1. 获利卖出测试

- **场景**: 持仓价格上涨超过设定的获利比例
- **触发条件**: 当前价格 >= 买入价格 × 获利比例
- **预期结果**: 按设定比例卖出持仓

### 2. 止损卖出测试

- **场景**: 持仓价格下跌且超过止损时间限制
- **触发条件**: 当前价格 <= 买入价格 × 止损比例 && 持仓时间 > 止损时间
- **预期结果**: 按设定比例卖出持仓

### 3. 回撤保护测试

- **场景**: 持仓价格曾经盈利，但现在回撤超过设定比例
- **触发条件**: 当前价格 <= 历史最高价 × 回撤比例 && 回撤时间 > 设定时间
- **预期结果**: 按设定比例卖出持仓

### 4. 多阶段卖出测试

- **第一阶段**: 初始卖出（默认50%）
- **第二阶段**: 二次卖出（默认60%）
- **第三阶段**: 清仓卖出（100%）

## 配置说明

### 测试环境配置

测试套件会自动配置以下测试参数：

```typescript
// 降低测试金额
solana.followAmount = 0.001

// 减少消费者数量
queue.consumerCount = 1

// 启用卖出策略
sellStrategy.enabled = true
```

### 策略测试配置

为了快速触发策略，测试器使用更激进的参数：

```typescript
// 初始策略
initial: {
  enabled: true,
  conditions: {
    profitRatio: 1.1,    // 10% 获利
    lossRatio: 0.9,      // 10% 亏损
    lossTimeMinutes: 1,  // 1分钟后止损
    pullbackRatio: 0.95, // 5% 回撤
    pullbackTimeMinutes: 1
  },
  sellRatio: 0.5 // 卖出50%
}
```

## 测试报告

### 端到端测试报告

完整测试会生成详细的报告，包括：

```
📊 综合测试报告:
================================================================================
🎯 测试概览:
   总测试数: 7
   通过测试: 7
   失败测试: 0
   成功率: 100.00%
   总耗时: 45.23 秒

📋 详细结果:
✅ [10:30:15] SYSTEM_HEALTH_CHECK: 系统健康检查通过
✅ [10:30:20] TEST_ENVIRONMENT_SETUP: 测试环境初始化成功
✅ [10:30:25] TEST_DATA_GENERATION: 测试数据生成成功
✅ [10:30:30] TRADING_FOLLOW_UP: 跟单功能测试通过
✅ [10:30:35] SELL_STRATEGY_TEST: 卖出策略测试通过
✅ [10:30:40] STRESS_TEST: 压力测试通过

🎯 测试建议:
   🟢 所有测试通过！系统运行正常
   🔥 可以开始生产环境部署
```

### 策略测试报告

策略测试会生成详细的触发分析：

```
📊 策略测试报告:
================================================================================
🎯 测试摘要:
   测试持仓数: 6
   策略触发成功: 6
   策略触发失败: 0
   成功率: 100.00%

📈 策略分布:
   初始策略: 3 个持仓
   二次策略: 2 个持仓
   三次策略: 1 个持仓
   已完成: 0 个持仓

🔍 触发条件分析:
   获利卖出: 2 次
   止损卖出: 2 次
   回撤保护: 2 次
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查 `app.db` 文件是否存在
   - 确保没有其他进程占用数据库

2. **配置错误**
   - 检查 `config.json` 文件格式
   - 验证所有必需字段是否存在

3. **区块链连接失败**
   - 检查网络连接
   - 验证 RPC 端点是否可用

4. **钱包连接失败**
   - 检查钱包私钥配置
   - 验证钱包地址格式

### 调试技巧

1. **启用详细日志**
   ```bash
   # 设置日志级别为 debug
   LOG_LEVEL=debug npm run test
   ```

2. **单步调试**
   ```bash
   # 只运行特定测试
   npm run test:health    # 只检查健康状态
   npm run test:data      # 只生成测试数据
   npm run test:strategy  # 只测试策略
   ```

3. **实时监控**
   ```bash
   # 启动实时监控
   npm run test:monitor
   ```

## 测试最佳实践

1. **定期运行测试**
   - 每次部署前运行完整测试
   - 配置更改后运行相关测试

2. **测试数据管理**
   - 使用独立的测试数据库
   - 定期清理测试数据

3. **性能监控**
   - 监控测试执行时间
   - 关注内存使用情况

4. **错误处理**
   - 保留详细的错误日志
   - 分析失败原因

## 扩展测试

### 添加自定义测试场景

```typescript
// 在 testDataGenerator.ts 中添加新场景
async createCustomScenario(): Promise<void> {
  const position = await this.createTestPosition(
    'CUSTOM_TOKEN',
    0.001,      // 买入价格
    5000,       // 数量
    0.0012,     // 当前价格
    60 * 60     // 持有时间（秒）
  );
  
  console.log('创建自定义测试场景:', position.id);
}
```

### 自定义策略测试

```typescript
// 在 sellStrategyTester.ts 中添加自定义测试
async testCustomStrategy(): Promise<void> {
  // 自定义策略逻辑
  const result = await this.strategyManager.evaluateSellConditions(position);
  console.log('自定义策略测试结果:', result);
}
```

## 结语

这个测试套件提供了全面的测试覆盖，确保系统的稳定性和可靠性。通过定期运行这些测试，您可以：

- 及早发现问题
- 验证配置更改
- 监控系统健康状态
- 优化策略参数
- 提高系统可靠性

如果您遇到问题或需要添加新的测试功能，请参考相关的测试文件或联系开发团队。 